2026-02-20 16:52:27,452 INFO ipython === bench console session ===
2026-02-20 16:52:27,453 INFO ipython doc = frappe.get_single("Installed Applications")

doc.installed_applications = [
    d for d in doc.installed_applications
    if d.app_name != "ipshopy"
]

doc.save(ignore_permissions=True)
frappe.db.commit()

print("Removed ipshopy successfully")
2026-02-20 16:52:27,453 INFO ipython frappe.db.sql("""
DELETE FROM `tabInstalled Applications`
WHERE app_name = 'ipshopy'
""")

frappe.db.commit()

print("ipshopy removed from DB")
2026-02-20 16:52:27,453 INFO ipython frappe.get_site_config()
2026-02-20 16:52:27,453 INFO ipython frappe.db.set_default("installed_apps", ["frappe", "crm"])
frappe.db.commit()

print("Installed apps reset")
2026-02-20 16:52:27,453 INFO ipython === session end ===
2026-02-23 16:21:37,908 INFO ipython === bench console session ===
2026-02-23 16:21:37,909 INFO ipython import frappe
2026-02-23 16:21:37,910 INFO ipython # Verify DocTypes exist
2026-02-23 16:21:37,910 INFO ipython print("=== DocType Verification ===")
2026-02-23 16:21:37,910 INFO ipython for dt in ["Department Pipeline Stage", "Department Shift", "Department Transition Rule", "Lead Department Log"]:
    count = frappe.db.count(dt)
    print(f"  {dt}: {count} records")
2026-02-23 16:21:37,910 INFO ipython # Verify custom fields on CRM Lead
2026-02-23 16:21:37,910 INFO ipython print("\n=== Custom Fields on CRM Lead ===")
2026-02-23 16:21:37,910 INFO ipython cfields = frappe.get_all("Custom Field", filters={"dt": "CRM Lead", "module": "Lead Routing"}, pluck="fieldname")
2026-02-23 16:21:37,910 INFO ipython print(f"  Fields: {cfields}")
2026-02-23 16:21:37,910 INFO ipython # Verify roles
2026-02-23 16:21:37,910 INFO ipython print("\n=== Department Roles ===")
2026-02-23 16:21:37,910 INFO ipython roles = frappe.get_all("Role", filters={"is_custom": 1, "name": ("like", "%User")}, pluck="name")
2026-02-23 16:21:37,910 INFO ipython roles += frappe.get_all("Role", filters={"is_custom": 1, "name": ("like", "%Manager%")}, pluck="name")
2026-02-23 16:21:37,910 INFO ipython print(f"  Roles: {sorted(set(roles))}")
2026-02-23 16:21:37,910 INFO ipython # Verify transition rules
2026-02-23 16:21:37,910 INFO ipython print("\n=== Transition Rules ===")
2026-02-23 16:21:37,910 INFO ipython rules = frappe.get_all("Department Transition Rule", fields=["from_stage", "to_stage", "transition_type"])
2026-02-23 16:21:37,910 INFO ipython for r in rules:
    print(f"  {r.from_stage} → {r.to_stage} ({r.transition_type})")
2026-02-23 16:21:37,910 INFO ipython frappe.db.rollback()
2026-02-23 16:21:37,910 INFO ipython === session end ===
2026-02-23 16:55:13,096 INFO ipython === bench console session ===
2026-02-23 16:55:13,098 INFO ipython import frappe
2026-02-23 16:55:13,099 INFO ipython # 1. Run the updated setup to add DocPerm entries
2026-02-23 16:55:13,099 INFO ipython from lead_routing.setup import _ensure_crm_lead_permissions
2026-02-23 16:55:13,099 INFO ipython _ensure_crm_lead_permissions()
2026-02-23 16:55:13,100 INFO ipython # 2. Find all users who have any department role but NOT Sales User
2026-02-23 16:55:13,100 INFO ipython dept_roles = [
    "Seller Onboarding User", "Seller Onboarding Manager",
    "Product Listing User", "Product Listing Manager",
    "Google Ads User", "Google Ads Manager",
    "Account Manager User", "Account Manager Manager",
    "Completion User", "Completion Manager",
]
2026-02-23 16:55:13,100 INFO ipython all_users = frappe.get_all("Has Role", filters={"role": ("in", dept_roles)}, pluck="parent", distinct=True)
2026-02-23 16:55:13,100 INFO ipython print(f"\nUsers with department roles: {all_users}")
2026-02-23 16:55:13,100 INFO ipython for user_email in all_users:
    if user_email in ("Administrator", "Guest"):
        continue
    user = frappe.get_doc("User", user_email)
    user_roles = [r.role for r in user.roles]
    
2026-02-23 16:55:13,100 INFO ipython     if "Sales User" not in user_roles:
        user.append("roles", {"role": "Sales User"})
        user.save(ignore_permissions=True)
        print(f"  Added 'Sales User' role to: {user_email}")
    else:
        print(f"  {user_email} already has 'Sales User' role")
2026-02-23 16:55:13,101 INFO ipython frappe.db.commit()
2026-02-23 16:55:13,101 INFO ipython print("\n✅ All department users now have CRM access!")
2026-02-23 16:55:13,102 INFO ipython === session end ===
2026-02-23 17:04:37,985 INFO ipython === bench console session ===
2026-02-23 17:04:37,985 INFO ipython import frappe
2026-02-23 17:04:37,985 INFO ipython # List all non-admin users with their roles and user_type
2026-02-23 17:04:37,985 INFO ipython users = frappe.get_all("User", filters={"name": ("not in", ["Administrator", "Guest"])}, fields=["name", "user_type", "module_profile", "role_profile_name", "enabled"])
2026-02-23 17:04:37,985 INFO ipython for u in users:
    roles = frappe.get_all("Has Role", filters={"parent": u.name}, pluck="role")
    blocked_modules = frappe.get_all("Block Module", filters={"parent": u.name}, pluck="module")
    print(f"\nUser: {u.name}")
    print(f"  user_type: {u.user_type}")
    print(f"  enabled: {u.enabled}")
    print(f"  module_profile: {u.module_profile}")
    print(f"  role_profile: {u.role_profile_name}")
    print(f"  roles: {roles}")
    print(f"  blocked_modules: {blocked_modules}")
2026-02-23 17:04:37,986 INFO ipython frappe.db.rollback()
2026-02-23 17:04:37,986 INFO ipython === session end ===
2026-02-23 17:05:48,077 INFO ipython === bench console session ===
2026-02-23 17:05:48,077 INFO ipython import frappe
2026-02-23 17:05:48,077 INFO ipython # Fix the user — remove Desk from blocked modules, ensure FCRM is accessible
2026-02-23 17:05:48,078 INFO ipython user = frappe.get_doc("User", "achintya.choudhari@gmail.com")
2026-02-23 17:05:48,078 INFO ipython print(f"User: {user.name}")
2026-02-23 17:05:48,078 INFO ipython print(f"Current blocked modules: {[d.module for d in user.block_modules]}")
2026-02-23 17:05:48,078 INFO ipython # Remove ALL blocked modules — let them access everything
2026-02-23 17:05:48,078 INFO ipython user.block_modules = []
2026-02-23 17:05:48,078 INFO ipython # Also remove the role profile if it's interfering
2026-02-23 17:05:48,078 INFO ipython if user.role_profile_name:
    print(f"Removing role profile: {user.role_profile_name}")
    user.role_profile_name = ""
2026-02-23 17:05:48,078 INFO ipython # Make sure they have the department role
2026-02-23 17:05:48,078 INFO ipython user_roles = [r.role for r in user.roles]
2026-02-23 17:05:48,078 INFO ipython if "Seller Onboarding User" not in user_roles:
    user.append("roles", {"role": "Seller Onboarding User"})
    print("Added Seller Onboarding User role")
2026-02-23 17:05:48,078 INFO ipython # Remove Sales User if present (no longer needed since we override check_app_permission)
2026-02-23 17:05:48,078 INFO ipython # But keep it if it doesn't hurt
2026-02-23 17:05:48,079 INFO ipython print(f"Final roles: {[r.role for r in user.roles]}")
2026-02-23 17:05:48,079 INFO ipython print(f"Final blocked modules: {[d.module for d in user.block_modules]}")
2026-02-23 17:05:48,079 INFO ipython user.save(ignore_permissions=True)
2026-02-23 17:05:48,079 INFO ipython frappe.db.commit()
2026-02-23 17:05:48,079 INFO ipython print("\n✅ User fixed!")
2026-02-23 17:05:48,079 INFO ipython === session end ===
2026-02-23 17:09:11,068 INFO ipython === bench console session ===
2026-02-23 17:09:11,068 INFO ipython import frappe
2026-02-23 17:09:11,068 INFO ipython # 1. Verify the monkey-patch works
2026-02-23 17:09:11,068 INFO ipython from lead_routing.api.crm_access import patch_crm_permission
2026-02-23 17:09:11,069 INFO ipython patch_crm_permission()
2026-02-23 17:09:11,069 INFO ipython import crm.api as crm_api
2026-02-23 17:09:11,069 INFO ipython print(f"crm.api.check_app_permission points to: {crm_api.check_app_permission.__module__}.{crm_api.check_app_permission.__name__}")
2026-02-23 17:09:11,069 INFO ipython # 2. Test as the department user
2026-02-23 17:09:11,069 INFO ipython frappe.set_user("achintya.choudhari@gmail.com")
2026-02-23 17:09:11,069 INFO ipython roles = frappe.get_roles()
2026-02-23 17:09:11,069 INFO ipython print(f"\nUser roles: {roles}")
2026-02-23 17:09:11,070 INFO ipython result = crm_api.check_app_permission()
2026-02-23 17:09:11,070 INFO ipython print(f"CRM permission check result: {result}")
2026-02-23 17:09:11,070 INFO ipython # 3. Verify blocked modules are cleared
2026-02-23 17:09:11,070 INFO ipython user = frappe.get_doc("User", "achintya.choudhari@gmail.com")
2026-02-23 17:09:11,071 INFO ipython print(f"Blocked modules: {[d.module for d in user.block_modules]}")
2026-02-23 17:09:11,071 INFO ipython frappe.set_user("Administrator")
2026-02-23 17:09:11,072 INFO ipython frappe.db.rollback()
2026-02-23 17:09:11,072 INFO ipython === session end ===
2026-02-23 17:39:47,786 INFO ipython === bench console session ===
2026-02-23 17:39:47,786 INFO ipython import frappe
2026-02-23 17:39:47,787 INFO ipython script_code = """
class CRMLead {
  actions = []

  setupActions() {
    let doc = this.doc
    if (!doc.current_department) return

    let actions = []

    // 1. Mark Done button
    actions.push({
      label: 'Mark Done',
      buttonLabel: 'Routing',
      group: true,
      onClick: () => {
        createDialog({
          title: 'Mark Department Done',
          message: 'Mark this department\\'s work as done and move lead to the next department?',
          actions: [
            {
              label: 'Confirm',
              variant: 'solid',
              onClick: ({ close }) => {
                call('lead_routing.api.lead_transfer.mark_department_done', {
                  lead_name: doc.name,
                }).then((r) => {
                  close()
                  if (r.status === 'completed') {
                    toast.create({ title: 'Lead lifecycle completed!', icon: 'check-circle', iconClasses: 'text-green-600' })
                  } else {
                    toast.create({ title: 'Lead moved to ' + r.to, icon: 'check-circle', iconClasses: 'text-green-600' })
                  }
                  setTimeout(() => location.reload(), 500)
                }).catch((err) => {
                  toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                })
              }
            }
          ]
        })
      }
    })

    // 2. Send Back button
    actions.push({
      label: 'Send Back',
      buttonLabel: 'Routing',
      group: true,
      onClick: async () => {
        let rules = await call('frappe.client.get_list', {
          doctype: 'Department Transition Rule',
          filters: { from_stage: doc.current_department, transition_type: 'Backward', enabled: 1 },
          fields: ['to_stage'],
        })
        if (!rules || rules.length === 0) {
          toast.create({ title: 'No backward transitions available', icon: 'info', iconClasses: 'text-yellow-600' })
          return
        }
        let options = rules.map(r => ({ label: r.to_stage, value: r.to_stage }))
        createDialog({
          title: 'Send Lead Back',
          message: 'Select which department to send this lead back to:',
          fields: [{ label: 'Target Department', type: 'select', fieldname: 'target', options: options, required: true }],
          actions: [{
            label: 'Send Back',
            variant: 'solid',
            onClick: ({ close, values }) => {
              call('lead_routing.api.lead_transfer.send_back_to_department', {
                lead_name: doc.name,
                target_stage: values.target,
              }).then((r) => {
                close()
                toast.create({ title: 'Lead sent back to ' + r.to, icon: 'arrow-left-circle', iconClasses: 'text-orange-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    // 3. Reject to Onboarding button
    actions.push({
      label: 'Reject to Onboarding',
      buttonLabel: 'Routing',
      group: true,
      onClick: () => {
        createDialog({
          title: 'Reject Lead',
          message: 'Reject this lead back to Seller Onboarding? This is typically used when the lead needs to restart.',
          actions: [{
            label: 'Reject',
            variant: 'solid',
            theme: 'red',
            onClick: ({ close }) => {
              call('lead_routing.api.lead_transfer.reject_to_onboarding', {
                lead_name: doc.name,
              }).then((r) => {
                close()
                toast.create({ title: 'Lead rejected to ' + r.to, icon: 'rotate-ccw', iconClasses: 'text-red-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    // 4. Manager Override button
    actions.push({
      label: 'Manager Override',
      buttonLabel: 'Routing',
      group: true,
      onClick: async () => {
        let stages = await call('frappe.client.get_list', {
          doctype: 'Department Pipeline Stage',
          filters: { enabled: 1, name: ['!=', doc.current_department] },
          fields: ['name', 'stage_order'],
          order_by: 'stage_order asc',
        })
        if (!stages || stages.length === 0) {
          toast.create({ title: 'No other departments available', icon: 'info', iconClasses: 'text-yellow-600' })
          return
        }
        let options = stages.map(s => ({ label: s.name, value: s.name }))
        createDialog({
          title: 'Manager Override - Transfer Lead',
          fields: [
            { label: 'Transfer To', type: 'select', fieldname: 'target', options: options, required: true },
            { label: 'Reason / Notes', type: 'text', fieldname: 'notes' },
          ],
          actions: [{
            label: 'Transfer',
            variant: 'solid',
            onClick: ({ close, values }) => {
              call('lead_routing.api.lead_transfer.manager_override_transfer', {
                lead_name: doc.name,
                target_stage: values.target,
                notes: values.notes || '',
              }).then((r) => {
                close()
                toast.create({ title: 'Lead transferred to ' + r.to, icon: 'zap', iconClasses: 'text-blue-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    this.actions = actions
  }

  refresh() {
    this.setupActions()
  }
}
"""
2026-02-23 17:39:47,787 INFO ipython # Check if the script already exists
2026-02-23 17:39:47,787 INFO ipython existing = frappe.db.exists("CRM Form Script", {"dt": "CRM Lead", "name": ("like", "%Lead Routing%")})
2026-02-23 17:39:47,787 INFO ipython if existing:
    doc = frappe.get_doc("CRM Form Script", existing)
    doc.script = script_code
    doc.save(ignore_permissions=True)
    print(f"Updated existing CRM Form Script: {existing}")
else:
    doc = frappe.new_doc("CRM Form Script")
    doc.dt = "CRM Lead"
    doc.view = "Form"
    doc.enabled = 1
    doc.script = script_code
    doc.insert(ignore_permissions=True)
    print(f"Created CRM Form Script: {doc.name}")
2026-02-23 17:39:47,787 INFO ipython frappe.db.commit()
2026-02-23 17:39:47,787 INFO ipython print("✅ CRM Form Script for Lead Routing created!")
2026-02-23 17:39:47,787 INFO ipython === session end ===
2026-02-23 17:40:25,679 INFO ipython === bench console session ===
2026-02-23 17:40:25,680 INFO ipython import frappe
2026-02-23 17:40:25,680 INFO ipython script_code = '''
class CRMLead {
  actions = []

  setupActions() {
    let doc = this.doc
    if (!doc.current_department) return

    let actions = []

    // 1. Mark Done button
    actions.push({
      label: 'Mark Done',
      buttonLabel: 'Routing',
      group: true,
      onClick: () => {
        createDialog({
          title: 'Mark Department Done',
          message: "Mark this department's work as done and move lead to the next department?",
          actions: [
            {
              label: 'Confirm',
              variant: 'solid',
              onClick: ({ close }) => {
                call('lead_routing.api.lead_transfer.mark_department_done', {
                  lead_name: doc.name,
                }).then((r) => {
                  close()
                  if (r.status === 'completed') {
                    toast.create({ title: 'Lead lifecycle completed!', icon: 'check-circle', iconClasses: 'text-green-600' })
                  } else {
                    toast.create({ title: 'Lead moved to ' + r.to, icon: 'check-circle', iconClasses: 'text-green-600' })
                  }
                  setTimeout(() => location.reload(), 500)
                }).catch((err) => {
                  toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                })
              }
            }
          ]
        })
      }
    })

    // 2. Send Back button
    actions.push({
      label: 'Send Back',
      buttonLabel: 'Routing',
      group: true,
      onClick: async () => {
        let rules = await call('frappe.client.get_list', {
          doctype: 'Department Transition Rule',
          filters: { from_stage: doc.current_department, transition_type: 'Backward', enabled: 1 },
          fields: ['to_stage'],
        })
        if (!rules || rules.length === 0) {
          toast.create({ title: 'No backward transitions available', icon: 'info', iconClasses: 'text-yellow-600' })
          return
        }
        let options = rules.map(r => ({ label: r.to_stage, value: r.to_stage }))
        createDialog({
          title: 'Send Lead Back',
          message: 'Select which department to send this lead back to:',
          fields: [{ label: 'Target Department', type: 'select', fieldname: 'target', options: options, required: true }],
          actions: [{
            label: 'Send Back',
            variant: 'solid',
            onClick: ({ close, values }) => {
              call('lead_routing.api.lead_transfer.send_back_to_department', {
                lead_name: doc.name,
                target_stage: values.target,
              }).then((r) => {
                close()
                toast.create({ title: 'Lead sent back to ' + r.to, icon: 'arrow-left-circle', iconClasses: 'text-orange-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    // 3. Reject to Onboarding button
    actions.push({
      label: 'Reject to Onboarding',
      buttonLabel: 'Routing',
      group: true,
      onClick: () => {
        createDialog({
          title: 'Reject Lead',
          message: 'Reject this lead back to Seller Onboarding?',
          actions: [{
            label: 'Reject',
            variant: 'solid',
            theme: 'red',
            onClick: ({ close }) => {
              call('lead_routing.api.lead_transfer.reject_to_onboarding', {
                lead_name: doc.name,
              }).then((r) => {
                close()
                toast.create({ title: 'Lead rejected to ' + r.to, icon: 'rotate-ccw', iconClasses: 'text-red-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    // 4. Manager Override button
    actions.push({
      label: 'Manager Override',
      buttonLabel: 'Routing',
      group: true,
      onClick: async () => {
        let stages = await call('frappe.client.get_list', {
          doctype: 'Department Pipeline Stage',
          filters: { enabled: 1, name: ['!=', doc.current_department] },
          fields: ['name', 'stage_order'],
          order_by: 'stage_order asc',
        })
        if (!stages || stages.length === 0) {
          toast.create({ title: 'No other departments available', icon: 'info', iconClasses: 'text-yellow-600' })
          return
        }
        let options = stages.map(s => ({ label: s.name, value: s.name }))
        createDialog({
          title: 'Manager Override - Transfer Lead',
          fields: [
            { label: 'Transfer To', type: 'select', fieldname: 'target', options: options, required: true },
            { label: 'Reason / Notes', type: 'text', fieldname: 'notes' },
          ],
          actions: [{
            label: 'Transfer',
            variant: 'solid',
            onClick: ({ close, values }) => {
              call('lead_routing.api.lead_transfer.manager_override_transfer', {
                lead_name: doc.name,
                target_stage: values.target,
                notes: values.notes || '',
              }).then((r) => {
                close()
                toast.create({ title: 'Lead transferred to ' + r.to, icon: 'zap', iconClasses: 'text-blue-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    this.actions = actions
  }

  refresh() {
    this.setupActions()
  }
}
'''
2026-02-23 17:40:25,680 INFO ipython # Delete if exists
2026-02-23 17:40:25,680 INFO ipython existing = frappe.db.get_value("CRM Form Script", {"dt": "CRM Lead", "name": ("like", "%Lead Routing%")})
2026-02-23 17:40:25,680 INFO ipython if existing:
    frappe.delete_doc("CRM Form Script", existing, force=True)
    print(f"Deleted old: {existing}")
2026-02-23 17:40:25,680 INFO ipython doc = frappe.new_doc("CRM Form Script")
2026-02-23 17:40:25,680 INFO ipython doc.__newname = "Lead Routing Actions"
2026-02-23 17:40:25,680 INFO ipython doc.dt = "CRM Lead"
2026-02-23 17:40:25,680 INFO ipython doc.view = "Form"
2026-02-23 17:40:25,680 INFO ipython doc.enabled = 1
2026-02-23 17:40:25,680 INFO ipython doc.script = script_code
2026-02-23 17:40:25,680 INFO ipython doc.insert(ignore_permissions=True)
2026-02-23 17:40:25,681 INFO ipython frappe.db.commit()
2026-02-23 17:40:25,681 INFO ipython print(f"✅ Created CRM Form Script: {doc.name}")
2026-02-23 17:40:25,681 INFO ipython === session end ===
2026-02-23 17:41:10,377 INFO ipython === bench console session ===
2026-02-23 17:41:10,377 INFO ipython import frappe
2026-02-23 17:41:10,378 INFO ipython # Check all CRM Leads and their routing fields
2026-02-23 17:41:10,378 INFO ipython leads = frappe.get_all("CRM Lead", fields=["name", "current_department", "current_shift", "department_status"])
2026-02-23 17:41:10,378 INFO ipython print("=== CRM Leads ===")
2026-02-23 17:41:10,378 INFO ipython for lead in leads:
    print(f"  {lead.name}: dept={lead.current_department}, shift={lead.current_shift}, status={lead.department_status}")
2026-02-23 17:41:10,378 INFO ipython # Also verify the CRM Form Script exists
2026-02-23 17:41:10,378 INFO ipython script = frappe.get_doc("CRM Form Script", "Lead Routing Actions")
2026-02-23 17:41:10,378 INFO ipython print(f"\n=== CRM Form Script ===")
2026-02-23 17:41:10,378 INFO ipython print(f"  Name: {script.name}")
2026-02-23 17:41:10,378 INFO ipython print(f"  DocType: {script.dt}")
2026-02-23 17:41:10,378 INFO ipython print(f"  View: {script.view}")
2026-02-23 17:41:10,378 INFO ipython print(f"  Enabled: {script.enabled}")
2026-02-23 17:41:10,378 INFO ipython print(f"  Script length: {len(script.script)} chars")
2026-02-23 17:41:10,378 INFO ipython frappe.db.rollback()
2026-02-23 17:41:10,378 INFO ipython === session end ===
2026-02-23 17:48:59,472 INFO ipython === bench console session ===
2026-02-23 17:48:59,473 INFO ipython import frappe
2026-02-23 17:48:59,474 INFO ipython script_code = '''
class CRMLead {

  onLoad() {
    this.setupActions()
  }

  setupActions() {
    let doc = this.doc
    if (!doc || !doc.current_department) return

    let actions = []

    // 1. Mark Done
    actions.push({
      label: 'Mark Done',
      buttonLabel: 'Routing',
      group: true,
      onClick: () => {
        createDialog({
          title: 'Mark Department Done',
          message: "Mark this department's work as done and move lead to the next department?",
          actions: [
            {
              label: 'Confirm',
              variant: 'solid',
              onClick: ({ close }) => {
                call('lead_routing.api.lead_transfer.mark_department_done', {
                  lead_name: doc.name,
                }).then((r) => {
                  close()
                  toast.create({ title: r.status === 'completed' ? 'Lead lifecycle completed!' : 'Lead moved to ' + r.to, icon: 'check-circle', iconClasses: 'text-green-600' })
                  setTimeout(() => location.reload(), 500)
                }).catch((err) => {
                  toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                })
              }
            }
          ]
        })
      }
    })

    // 2. Send Back
    actions.push({
      label: 'Send Back',
      buttonLabel: 'Routing',
      group: true,
      onClick: async () => {
        let rules = await call('frappe.client.get_list', {
          doctype: 'Department Transition Rule',
          filters: { from_stage: doc.current_department, transition_type: 'Backward', enabled: 1 },
          fields: ['to_stage'],
        })
        if (!rules || rules.length === 0) {
          toast.create({ title: 'No backward transitions available', icon: 'info', iconClasses: 'text-yellow-600' })
          return
        }
        let options = rules.map(r => ({ label: r.to_stage, value: r.to_stage }))
        createDialog({
          title: 'Send Lead Back',
          message: 'Select which department to send this lead back to:',
          fields: [{ label: 'Target Department', type: 'select', fieldname: 'target', options: options, required: true }],
          actions: [{
            label: 'Send Back',
            variant: 'solid',
            onClick: ({ close, values }) => {
              call('lead_routing.api.lead_transfer.send_back_to_department', {
                lead_name: doc.name,
                target_stage: values.target,
              }).then((r) => {
                close()
                toast.create({ title: 'Lead sent back to ' + r.to, icon: 'arrow-left-circle', iconClasses: 'text-orange-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    // 3. Reject to Onboarding
    actions.push({
      label: 'Reject to Onboarding',
      buttonLabel: 'Routing',
      group: true,
      onClick: () => {
        createDialog({
          title: 'Reject Lead',
          message: 'Reject this lead back to Seller Onboarding?',
          actions: [{
            label: 'Reject',
            variant: 'solid',
            theme: 'red',
            onClick: ({ close }) => {
              call('lead_routing.api.lead_transfer.reject_to_onboarding', {
                lead_name: doc.name,
              }).then((r) => {
                close()
                toast.create({ title: 'Lead rejected to ' + r.to, icon: 'rotate-ccw', iconClasses: 'text-red-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    // 4. Manager Override
    actions.push({
      label: 'Manager Override',
      buttonLabel: 'Routing',
      group: true,
      onClick: async () => {
        let stages = await call('frappe.client.get_list', {
          doctype: 'Department Pipeline Stage',
          filters: { enabled: 1 },
          fields: ['name', 'stage_order'],
          order_by: 'stage_order asc',
        })
        if (!stages || stages.length === 0) return
        stages = stages.filter(s => s.name !== doc.current_department)
        let options = stages.map(s => ({ label: s.name, value: s.name }))
        createDialog({
          title: 'Manager Override - Transfer Lead',
          fields: [
            { label: 'Transfer To', type: 'select', fieldname: 'target', options: options, required: true },
            { label: 'Reason / Notes', type: 'text', fieldname: 'notes' },
          ],
          actions: [{
            label: 'Transfer',
            variant: 'solid',
            onClick: ({ close, values }) => {
              call('lead_routing.api.lead_transfer.manager_override_transfer', {
                lead_name: doc.name,
                target_stage: values.target,
                notes: values.notes || '',
              }).then((r) => {
                close()
                toast.create({ title: 'Lead transferred to ' + r.to, icon: 'zap', iconClasses: 'text-blue-600' })
                setTimeout(() => location.reload(), 500)
              }).catch((err) => {
                toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
              })
            }
          }]
        })
      }
    })

    this.actions = actions
  }
}
'''
2026-02-23 17:48:59,474 INFO ipython doc = frappe.get_doc("CRM Form Script", "Lead Routing Actions")
2026-02-23 17:48:59,474 INFO ipython doc.script = script_code
2026-02-23 17:48:59,474 INFO ipython doc.save(ignore_permissions=True)
2026-02-23 17:48:59,474 INFO ipython frappe.db.commit()
2026-02-23 17:48:59,474 INFO ipython print(f"✅ Updated CRM Form Script: {doc.name}")
2026-02-23 17:48:59,474 INFO ipython print(f"   Script length: {len(doc.script)} chars")
2026-02-23 17:48:59,474 INFO ipython === session end ===
2026-02-23 17:51:44,483 INFO ipython === bench console session ===
2026-02-23 17:51:44,485 INFO ipython import frappe
2026-02-23 17:51:44,485 INFO ipython # Check what the API would return for CRM Form Scripts
2026-02-23 17:51:44,485 INFO ipython scripts = frappe.get_all("CRM Form Script", filters={"view": "Form", "dt": "CRM Lead", "enabled": 1}, fields=["name", "dt", "view"])
2026-02-23 17:51:44,485 INFO ipython print("CRM Form Scripts for CRM Lead:")
2026-02-23 17:51:44,485 INFO ipython for s in scripts:
    print(f"  {s}")
2026-02-23 17:51:44,485 INFO ipython # Also, let's verify the script can actually be parsed as valid JS
2026-02-23 17:51:44,485 INFO ipython doc = frappe.get_doc("CRM Form Script", "Lead Routing Actions")
2026-02-23 17:51:44,485 INFO ipython print(f"\nFirst 200 chars of script:\n{doc.script[:200]}")
2026-02-23 17:51:44,485 INFO ipython frappe.db.rollback()
2026-02-23 17:51:44,485 INFO ipython === session end ===
2026-02-23 17:54:48,595 INFO ipython === bench console session ===
2026-02-23 17:54:48,596 INFO ipython import frappe
2026-02-23 17:54:48,596 INFO ipython script_code = '''
class CRMLead {

  onLoad() {
    this.setupActions()
  }

  setupActions() {
    let doc = this.doc
    if (!doc || !doc.current_department) return

    let routingItems = [
      {
        label: 'Mark Done',
        onClick: () => {
          createDialog({
            title: 'Mark Department Done',
            message: "Mark this department's work as done and move lead to the next stage?",
            actions: [
              {
                label: 'Confirm',
                variant: 'solid',
                onClick: ({ close }) => {
                  call('lead_routing.api.lead_transfer.mark_department_done', {
                    lead_name: doc.name,
                  }).then((r) => {
                    close()
                    toast.create({
                      title: r.status === 'completed' ? 'Lead lifecycle completed!' : 'Moved to ' + r.to,
                      icon: 'check-circle',
                      iconClasses: 'text-green-600',
                    })
                    setTimeout(() => location.reload(), 500)
                  }).catch((err) => {
                    toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                  })
                },
              },
            ],
          })
        },
      },
      {
        label: 'Send Back',
        onClick: async () => {
          let rules = await call('frappe.client.get_list', {
            doctype: 'Department Transition Rule',
            filters: { from_stage: doc.current_department, transition_type: 'Backward', enabled: 1 },
            fields: ['to_stage'],
          })
          if (!rules || rules.length === 0) {
            toast.create({ title: 'No backward transitions available', icon: 'info', iconClasses: 'text-yellow-600' })
            return
          }
          let options = rules.map((r) => ({ label: r.to_stage, value: r.to_stage }))
          createDialog({
            title: 'Send Lead Back',
            message: 'Select department to send back to:',
            fields: [{ label: 'Target Department', type: 'select', fieldname: 'target', options: options, required: true }],
            actions: [
              {
                label: 'Send Back',
                variant: 'solid',
                onClick: ({ close, values }) => {
                  call('lead_routing.api.lead_transfer.send_back_to_department', {
                    lead_name: doc.name,
                    target_stage: values.target,
                  }).then((r) => {
                    close()
                    toast.create({ title: 'Sent back to ' + r.to, icon: 'arrow-left-circle', iconClasses: 'text-orange-600' })
                    setTimeout(() => location.reload(), 500)
                  }).catch((err) => {
                    toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                  })
                },
              },
            ],
          })
        },
      },
      {
        label: 'Reject to Onboarding',
        onClick: () => {
          createDialog({
            title: 'Reject Lead',
            message: 'Reject this lead back to Seller Onboarding?',
            actions: [
              {
                label: 'Reject',
                variant: 'solid',
                theme: 'red',
                onClick: ({ close }) => {
                  call('lead_routing.api.lead_transfer.reject_to_onboarding', {
                    lead_name: doc.name,
                  }).then((r) => {
                    close()
                    toast.create({ title: 'Rejected to ' + r.to, icon: 'rotate-ccw', iconClasses: 'text-red-600' })
                    setTimeout(() => location.reload(), 500)
                  }).catch((err) => {
                    toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                  })
                },
              },
            ],
          })
        },
      },
      {
        label: 'Manager Override',
        onClick: async () => {
          let stages = await call('frappe.client.get_list', {
            doctype: 'Department Pipeline Stage',
            filters: { enabled: 1 },
            fields: ['name', 'stage_order'],
            order_by: 'stage_order asc',
          })
          if (!stages || stages.length === 0) return
          stages = stages.filter((s) => s.name !== doc.current_department)
          let options = stages.map((s) => ({ label: s.name, value: s.name }))
          createDialog({
            title: 'Manager Override',
            fields: [
              { label: 'Transfer To', type: 'select', fieldname: 'target', options: options, required: true },
              { label: 'Reason / Notes', type: 'text', fieldname: 'notes' },
            ],
            actions: [
              {
                label: 'Transfer',
                variant: 'solid',
                onClick: ({ close, values }) => {
                  call('lead_routing.api.lead_transfer.manager_override_transfer', {
                    lead_name: doc.name,
                    target_stage: values.target,
                    notes: values.notes || '',
                  }).then((r) => {
                    close()
                    toast.create({ title: 'Transferred to ' + r.to, icon: 'zap', iconClasses: 'text-blue-600' })
                    setTimeout(() => location.reload(), 500)
                  }).catch((err) => {
                    toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                  })
                },
              },
            ],
          })
        },
      },
    ]

    // Use the grouped "..." menu format that frappe-ui Dropdown expects
    this.actions = [
      {
        group: 'Routing',
        items: routingItems,
      },
    ]
  }
}
'''
2026-02-23 17:54:48,596 INFO ipython doc = frappe.get_doc("CRM Form Script", "Lead Routing Actions")
2026-02-23 17:54:48,596 INFO ipython doc.script = script_code
2026-02-23 17:54:48,596 INFO ipython doc.save(ignore_permissions=True)
2026-02-23 17:54:48,596 INFO ipython frappe.db.commit()
2026-02-23 17:54:48,596 INFO ipython print(f"Updated CRM Form Script: {doc.name}")
2026-02-23 17:54:48,596 INFO ipython === session end ===
2026-02-23 18:11:34,088 INFO ipython === bench console session ===
2026-02-23 18:11:34,088 INFO ipython import frappe
2026-02-23 18:11:34,089 INFO ipython script_code = '''
class CRMLead {

  onLoad() {
    this.setupActions()
  }

  setupActions() {
    let doc = this.doc
    if (!doc || !doc.current_department) return

    let routingItems = [
      {
        label: 'Mark Done',
        onClick: () => {
          createDialog({
            title: 'Mark Department Done',
            message: "Mark department work as done and move lead to the next stage?",
            actions: [
              {
                label: 'Confirm',
                variant: 'solid',
                onClick: ({ close }) => {
                  call('lead_routing.api.lead_transfer.mark_department_done', {
                    lead_name: doc.name,
                  }).then((r) => {
                    close()
                    toast.create({
                      title: r.status === 'completed' ? 'Lead lifecycle completed!' : 'Moved to ' + r.to,
                      icon: 'check-circle',
                      iconClasses: 'text-green-600',
                    })
                    setTimeout(() => location.reload(), 800)
                  }).catch((err) => {
                    toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                  })
                },
              },
            ],
          })
        },
      },
      {
        label: 'Send Back',
        onClick: async () => {
          let rules = await call('frappe.client.get_list', {
            doctype: 'Department Transition Rule',
            filters: { from_stage: doc.current_department, transition_type: 'Backward', enabled: 1 },
            fields: ['to_stage'],
          })
          if (!rules || rules.length === 0) {
            toast.create({ title: 'No backward transitions available', icon: 'info', iconClasses: 'text-yellow-600' })
            return
          }
          let optionsHtml = rules.map(r => '<option value="' + r.to_stage + '">' + r.to_stage + '</option>').join('')
          createDialog({
            title: 'Send Lead Back',
            html: '<div style="margin-top: 8px;"><label style="font-size: 13px; font-weight: 500; color: #64748b;">Target Department</label><select id="lr-send-back-target" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px; font-size: 14px; background: white; outline: none;">' + optionsHtml + '</select></div>',
            actions: [{
              label: 'Send Back',
              variant: 'solid',
              onClick: ({ close }) => {
                let target = document.getElementById('lr-send-back-target')?.value
                if (!target) {
                  toast.create({ title: 'Please select a department', icon: 'x-circle', iconClasses: 'text-red-600' })
                  return
                }
                call('lead_routing.api.lead_transfer.send_back_to_department', {
                  lead_name: doc.name,
                  target_stage: target,
                }).then((r) => {
                  close()
                  toast.create({ title: 'Sent back to ' + r.to, icon: 'check-circle', iconClasses: 'text-green-600' })
                  setTimeout(() => location.reload(), 800)
                }).catch((err) => {
                  toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                })
              }
            }]
          })
        },
      },
      {
        label: 'Reject to Onboarding',
        onClick: () => {
          createDialog({
            title: 'Reject Lead',
            message: 'Reject this lead back to Seller Onboarding? This is typically used when the lead needs to restart.',
            actions: [{
              label: 'Reject',
              variant: 'solid',
              theme: 'red',
              onClick: ({ close }) => {
                call('lead_routing.api.lead_transfer.reject_to_onboarding', {
                  lead_name: doc.name,
                }).then((r) => {
                  close()
                  toast.create({ title: 'Rejected to ' + r.to, icon: 'check-circle', iconClasses: 'text-green-600' })
                  setTimeout(() => location.reload(), 800)
                }).catch((err) => {
                  toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                })
              }
            }]
          })
        },
      },
      {
        label: 'Manager Override',
        onClick: async () => {
          let stages = await call('frappe.client.get_list', {
            doctype: 'Department Pipeline Stage',
            filters: { enabled: 1 },
            fields: ['name', 'stage_order'],
            order_by: 'stage_order asc',
          })
          if (!stages || stages.length === 0) return
          stages = stages.filter(s => s.name !== doc.current_department)
          let optionsHtml = stages.map(s => '<option value="' + s.name + '">' + s.name + '</option>').join('')
          createDialog({
            title: 'Manager Override - Transfer Lead',
            html: '<div style="margin-top: 8px;"><label style="font-size: 13px; font-weight: 500; color: #64748b;">Transfer To</label><select id="lr-override-target" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px; font-size: 14px; background: white; outline: none;">' + optionsHtml + '</select></div><div style="margin-top: 12px;"><label style="font-size: 13px; font-weight: 500; color: #64748b;">Reason / Notes</label><textarea id="lr-override-notes" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px; font-size: 14px; resize: vertical; outline: none;" placeholder="Optional notes..."></textarea></div>',
            actions: [{
              label: 'Transfer',
              variant: 'solid',
              onClick: ({ close }) => {
                let target = document.getElementById('lr-override-target')?.value
                let notes = document.getElementById('lr-override-notes')?.value || ''
                if (!target) {
                  toast.create({ title: 'Please select a department', icon: 'x-circle', iconClasses: 'text-red-600' })
                  return
                }
                call('lead_routing.api.lead_transfer.manager_override_transfer', {
                  lead_name: doc.name,
                  target_stage: target,
                  notes: notes,
                }).then((r) => {
                  close()
                  toast.create({ title: 'Transferred to ' + r.to, icon: 'check-circle', iconClasses: 'text-green-600' })
                  setTimeout(() => location.reload(), 800)
                }).catch((err) => {
                  toast.create({ title: err.messages?.[0] || 'Error', icon: 'x-circle', iconClasses: 'text-red-600' })
                })
              }
            }]
          })
        },
      },
    ]

    this.actions = [
      {
        group: 'Routing',
        items: routingItems,
      },
    ]
  }
}
'''
2026-02-23 18:11:34,089 INFO ipython doc = frappe.get_doc("CRM Form Script", "Lead Routing Actions")
2026-02-23 18:11:34,089 INFO ipython doc.script = script_code
2026-02-23 18:11:34,089 INFO ipython doc.save(ignore_permissions=True)
2026-02-23 18:11:34,089 INFO ipython frappe.db.commit()
2026-02-23 18:11:34,089 INFO ipython print(f"Updated CRM Form Script: {doc.name}")
2026-02-23 18:11:34,089 INFO ipython === session end ===
2026-02-24 09:38:14,091 INFO ipython === bench console session ===
2026-02-24 09:38:14,093 INFO ipython import frappe
2026-02-24 09:38:14,093 INFO ipython # Check what users exist
2026-02-24 09:38:14,093 INFO ipython users = frappe.get_all("User", filters={"enabled": 1, "user_type": "System User"}, fields=["name", "full_name"])
2026-02-24 09:38:14,093 INFO ipython print("=== Available Users ===")
2026-02-24 09:38:14,094 INFO ipython for u in users:
    print(f"  {u.name} ({u.full_name})")
2026-02-24 09:38:14,094 INFO ipython # Check existing stages
2026-02-24 09:38:14,094 INFO ipython stages = frappe.get_all("Department Pipeline Stage", fields=["name", "stage_order"], order_by="stage_order asc")
2026-02-24 09:38:14,094 INFO ipython print("\n=== Pipeline Stages ===")
2026-02-24 09:38:14,094 INFO ipython for s in stages:
    stage = frappe.get_doc("Department Pipeline Stage", s.name)
    team = [m.user for m in stage.team_members] if stage.team_members else []
    print(f"  {s.name} (order={s.stage_order}): team={team}")
2026-02-24 09:38:14,094 INFO ipython frappe.db.rollback()
2026-02-24 09:38:14,094 INFO ipython === session end ===
2026-02-24 11:01:48,774 INFO ipython === bench console session ===
2026-02-24 11:01:48,775 INFO ipython import frappe
2026-02-24 11:01:48,775 INFO ipython # Fix lead_owner for existing assigned leads
2026-02-24 11:01:48,776 INFO ipython todos = frappe.get_all("ToDo", filters={"reference_type": "CRM Lead", "status": "Open"}, fields=["reference_name", "allocated_to"])
2026-02-24 11:01:48,776 INFO ipython for t in todos:
    frappe.db.set_value("CRM Lead", t.reference_name, "lead_owner", t.allocated_to, update_modified=False)
    print(f"Set lead_owner for {t.reference_name} to {t.allocated_to}")
frappe.db.commit()
2026-02-24 11:01:48,776 INFO ipython print("Done!")
2026-02-24 11:01:48,776 INFO ipython === session end ===
2026-02-24 11:51:24,354 INFO ipython === bench console session ===
2026-02-24 11:51:24,357 INFO ipython import frappe
2026-02-24 11:51:24,357 INFO ipython # Let's check the roles of 'Product Listing User' and the user trying it
2026-02-24 11:51:24,358 INFO ipython roles = frappe.get_all("Role", pluck="name")
2026-02-24 11:51:24,358 INFO ipython print("Roles:")
2026-02-24 11:51:24,359 INFO ipython for r in [r for r in roles if "Listing" in r or "Onboarding" in r or "Google" in r or "Account" in r]:
    print(r)
2026-02-24 11:51:24,360 INFO ipython print("\nDepartment Stages configuration:")
2026-02-24 11:51:24,360 INFO ipython stages = frappe.get_all("Department Pipeline Stage", fields=["name", "stage_name", "department_role", "manager_role"])
2026-02-24 11:51:24,361 INFO ipython for s in stages:
    print(dict(s))
2026-02-24 11:51:24,361 INFO ipython === session end ===
2026-02-24 11:51:43,325 INFO ipython === bench console session ===
2026-02-24 11:51:43,325 INFO ipython import frappe
2026-02-24 11:51:43,325 INFO ipython # Let's check what permissions Seller Onboarding User has
2026-02-24 11:51:43,326 INFO ipython perms = frappe.get_all("Custom DocPerm", 
    filters={"role": "Seller Onboarding User"}, 
    fields=["parent", "read", "write", "create", "submit", "share"]
)
2026-02-24 11:51:43,326 INFO ipython print("Seller Onboarding User Perms:")
2026-02-24 11:51:43,326 INFO ipython for p in perms:
    print(p)
2026-02-24 11:51:43,326 INFO ipython === session end ===
2026-02-24 11:52:04,509 INFO ipython === bench console session ===
2026-02-24 11:52:04,509 INFO ipython import frappe
2026-02-24 11:52:04,509 INFO ipython # Get base permissions
2026-02-24 11:52:04,509 INFO ipython base_role = "Seller Onboarding User"
2026-02-24 11:52:04,509 INFO ipython base_perms = frappe.get_all("Custom DocPerm", filters={"role": base_role}, fields=["*"])
2026-02-24 11:52:04,509 INFO ipython target_roles = [
    "Product Listing User", 
    "Google Ads User", 
    "Account Manager User",
    "Completion User"
]
2026-02-24 11:52:04,510 INFO ipython print(f"Copying permissions from {base_role} to {target_roles}")
2026-02-24 11:52:04,510 INFO ipython for role in target_roles:
    for perm in base_perms:
        # Check if it already exists
        exists = frappe.db.exists("Custom DocPerm", {"parent": perm.parent, "role": role})
        if not exists:
            new_perm = frappe.new_doc("Custom DocPerm")
            new_perm.update(perm)
            new_perm.role = role
            new_perm.name = None
            new_perm.insert(ignore_permissions=True)
            print(f"Added {perm.parent} access for {role}")
        else:
            print(f"{perm.parent} access already exists for {role}")
2026-02-24 11:52:04,511 INFO ipython frappe.db.commit()
2026-02-24 11:52:04,511 INFO ipython print("Done styling permissions!")
2026-02-24 11:52:04,511 INFO ipython === session end ===
2026-02-24 11:58:53,097 INFO ipython === bench console session ===
2026-02-24 11:58:53,097 INFO ipython import frappe
2026-02-24 11:58:53,099 INFO ipython from lead_routing.api.crm_access import _is_department_user
2026-02-24 11:58:53,099 INFO ipython user = "test_product_listing@example.com" # Just need to check the logic, will use frappe.session.user in real check
2026-02-24 11:58:53,099 INFO ipython # Let's see what user_dept_names becomes for a Product Listing User
2026-02-24 11:58:53,099 INFO ipython # I'll manually trace it
2026-02-24 11:58:53,099 INFO ipython user_roles = ["Product Listing User"]
2026-02-24 11:58:53,099 INFO ipython dept_stages = frappe.get_all("Department Pipeline Stage", filters={"enabled": 1}, fields=["name", "stage_name", "department_role", "current_shift"])
2026-02-24 11:58:53,099 INFO ipython user_dept_names = set()
2026-02-24 11:58:53,099 INFO ipython for stage in dept_stages:
    if stage.department_role and stage.department_role in user_roles:
        user_dept_names.add(stage.name)
2026-02-24 11:58:53,099 INFO ipython print("User dept names:", user_dept_names)
2026-02-24 11:58:53,099 INFO ipython # Check CRM Departments
2026-02-24 11:58:53,099 INFO ipython crm_depts = frappe.get_all("CRM Department", fields=["name", "department_name"])
2026-02-24 11:58:53,099 INFO ipython print("CRM Departments:")
2026-02-24 11:58:53,100 INFO ipython for c in crm_depts:
    print(dict(c))
2026-02-24 11:58:53,100 INFO ipython print("Pipeline Stages:")
2026-02-24 11:58:53,100 INFO ipython for s in dept_stages:
    print(dict(s))
2026-02-24 11:58:53,100 INFO ipython === session end ===
2026-02-24 12:09:12,917 INFO ipython === bench console session ===
2026-02-24 12:09:12,920 INFO ipython import frappe
2026-02-24 12:09:12,921 INFO ipython from lead_routing.api.crm_access import patched_get_hierarchy_tree
2026-02-24 12:09:12,921 INFO ipython # Check roles for user 'abcd' vs 'wereasd'
2026-02-24 12:09:12,921 INFO ipython abcd_roles = frappe.get_roles("abcd@gmail.com") # Assuming the email from screenshot
2026-02-24 12:09:12,921 INFO ipython wereasd_roles = frappe.get_roles("wereasd@gmail.com") # Guessing email
2026-02-24 12:09:12,921 INFO ipython print("User abcd roles:", abcd_roles)
2026-02-24 12:09:12,921 INFO ipython print("User wereasd roles:", wereasd_roles)
2026-02-24 12:09:12,921 INFO ipython === session end ===
2026-02-24 12:09:26,264 INFO ipython === bench console session ===
2026-02-24 12:09:26,265 INFO ipython import frappe
2026-02-24 12:09:26,265 INFO ipython # Let's get actual emails from the database
2026-02-24 12:09:26,265 INFO ipython users = frappe.get_all("User", filters={"enabled": 1, "name": ["not in", ["Administrator", "Guest"]]}, fields=["name", "full_name"])
2026-02-24 12:09:26,265 INFO ipython print("Active Users:")
2026-02-24 12:09:26,265 INFO ipython for u in users:
    roles = frappe.get_roles(u.name)
    print(f"{u.name} ({u.full_name}): {roles}")
2026-02-24 12:09:26,265 INFO ipython === session end ===
2026-02-24 12:09:43,967 INFO ipython === bench console session ===
2026-02-24 12:09:43,967 INFO ipython import frappe
2026-02-24 12:09:43,967 INFO ipython from crm.api.hierarchy import _original_get_hierarchy_tree
2026-02-24 12:09:43,967 INFO ipython # Let's test the logic from crm_access.py for abc@gmail.com
2026-02-24 12:09:43,967 INFO ipython user = "abc@gmail.com"
2026-02-24 12:09:43,967 INFO ipython user_roles = frappe.get_roles(user)
2026-02-24 12:09:43,968 INFO ipython print(f"User: {user}, Roles: {user_roles}")
2026-02-24 12:09:43,968 INFO ipython dept_stages = frappe.get_all(
    "Department Pipeline Stage",
    filters={"enabled": 1},
    fields=["name", "stage_name", "department_role", "manager_role"],
)
2026-02-24 12:09:43,968 INFO ipython user_dept_names = set()
2026-02-24 12:09:43,968 INFO ipython for stage in dept_stages:
    if (stage.department_role and stage.department_role in user_roles) or \
       (stage.manager_role and stage.manager_role in user_roles):
        user_dept_names.add(stage.name)
2026-02-24 12:09:43,969 INFO ipython print(f"User dept names (from Pipeline Stages): {user_dept_names}")
2026-02-24 12:09:43,969 INFO ipython full_tree = _original_get_hierarchy_tree()
2026-02-24 12:09:43,969 INFO ipython filtered_tree = []
2026-02-24 12:09:43,969 INFO ipython for shift in full_tree:
    filtered_shift = dict(shift)
    filtered_depts = []
2026-02-24 12:09:43,969 INFO ipython     for dept in shift.get("departments", []):
        dept_name = dept.get("name", "")
        dept_display = dept.get("department_name", "")
2026-02-24 12:09:43,969 INFO ipython         should_include = False
2026-02-24 12:09:43,969 INFO ipython         for ud in user_dept_names:
            stage_doc = frappe.get_doc("Department Pipeline Stage", ud)
            if (stage_doc.stage_name == dept_display or stage_doc.name == dept_name):
                should_include = True
                break
        
2026-02-24 12:09:43,969 INFO ipython         if should_include:
            filtered_depts.append(dept)
2026-02-24 12:09:43,969 INFO ipython     if filtered_depts:
        filtered_shift["departments"] = filtered_depts
        filtered_tree.append(filtered_shift)
2026-02-24 12:09:43,969 INFO ipython print("\n--- Filtered Tree Result ---")
2026-02-24 12:09:43,969 INFO ipython for shift in filtered_tree:
    print(f"Shift: {shift.get('shift_name')}")
    for dept in shift.get("departments", []):
        print(f"  - Dept: {dept.get('department_name')}")
2026-02-24 12:09:43,969 INFO ipython === session end ===
2026-02-24 12:09:55,321 INFO ipython === bench console session ===
2026-02-24 12:09:55,321 INFO ipython import frappe
2026-02-24 12:09:55,321 INFO ipython from lead_routing.api.crm_access import _is_department_manager, _is_department_user
2026-02-24 12:09:55,322 INFO ipython user = "abc@gmail.com" # Product listing user
2026-02-24 12:09:55,322 INFO ipython print("Is manager?", _is_department_manager(user))
2026-02-24 12:09:55,322 INFO ipython print("Is dept user?", _is_department_user(user))
2026-02-24 12:09:55,322 INFO ipython === session end ===
2026-02-24 12:10:18,004 INFO ipython === bench console session ===
2026-02-24 12:10:18,004 INFO ipython import frappe
2026-02-24 12:10:18,004 INFO ipython from crm.api.hierarchy import _original_get_hierarchy_tree
2026-02-24 12:10:18,004 INFO ipython # Define variables directly instead of importing missing piece by piece
2026-02-24 12:10:18,004 INFO ipython user = "abc@gmail.com"
2026-02-24 12:10:18,004 INFO ipython user_roles = frappe.get_roles(user)
2026-02-24 12:10:18,004 INFO ipython print(f"User roles: {user_roles}")
2026-02-24 12:10:18,004 INFO ipython dept_stages = frappe.get_all(
    "Department Pipeline Stage",
    filters={"enabled": 1},
    fields=["name", "stage_name", "department_role", "manager_role"],
)
2026-02-24 12:10:18,005 INFO ipython user_dept_names = set()
2026-02-24 12:10:18,005 INFO ipython for stage in dept_stages:
    if (stage.department_role and stage.department_role in user_roles) or \
       (stage.manager_role and stage.manager_role in user_roles):
        user_dept_names.add(stage.name)
2026-02-24 12:10:18,005 INFO ipython print(f"Detected dept names: {user_dept_names}")
2026-02-24 12:10:18,005 INFO ipython full_tree = _original_get_hierarchy_tree()
2026-02-24 12:10:18,005 INFO ipython filtered_tree = []
2026-02-24 12:10:18,005 INFO ipython for shift in full_tree:
    filtered_shift = dict(shift)
    filtered_depts = []
2026-02-24 12:10:18,005 INFO ipython     for dept in shift.get("departments", []):
        dept_name = dept.get("name", "")
        dept_display = dept.get("department_name", "")
2026-02-24 12:10:18,005 INFO ipython         should_include = False
2026-02-24 12:10:18,005 INFO ipython         for ud in user_dept_names:
            stage_doc = frappe.get_doc("Department Pipeline Stage", ud)
            if (stage_doc.stage_name == dept_display or stage_doc.name == dept_name):
                should_include = True
                break
        
2026-02-24 12:10:18,005 INFO ipython         if should_include:
            filtered_depts.append(dept)
2026-02-24 12:10:18,005 INFO ipython     if filtered_depts:
        filtered_shift["departments"] = filtered_depts
        filtered_tree.append(filtered_shift)
2026-02-24 12:10:18,005 INFO ipython print(f"Final filtered tree size: {len(filtered_tree)}")
2026-02-24 12:10:18,006 INFO ipython for shift in filtered_tree:
    print(shift.get("shift_name"), [d.get("department_name") for d in shift.get("departments")])
2026-02-24 12:10:18,006 INFO ipython === session end ===
2026-02-24 12:11:25,516 INFO ipython === bench console session ===
2026-02-24 12:11:25,517 INFO ipython import frappe
2026-02-24 12:11:25,517 INFO ipython # Let's see the actual DB values side by side
2026-02-24 12:11:25,517 INFO ipython print("--- CRM Departments ---")
2026-02-24 12:11:25,517 INFO ipython crm_depts = frappe.get_all("CRM Department", fields=["name", "department_name"])
2026-02-24 12:11:25,517 INFO ipython for d in crm_depts:
    print(f"Name: '{d.name}', Display: '{d.department_name}'")
2026-02-24 12:11:25,517 INFO ipython print("\n--- Pipeline Stages ---")
2026-02-24 12:11:25,517 INFO ipython stages = frappe.get_all("Department Pipeline Stage", fields=["name", "stage_name"])
2026-02-24 12:11:25,517 INFO ipython for s in stages:
    print(f"Name: '{s.name}', Display: '{s.stage_name}'")
2026-02-24 12:11:25,518 INFO ipython === session end ===
2026-02-24 12:47:19,959 INFO ipython === bench console session ===
2026-02-24 12:47:19,960 INFO ipython import frappe
2026-02-24 12:47:19,960 INFO ipython # Let's find a lead that is in Product Listing and see its shared users
2026-02-24 12:47:19,960 INFO ipython leads = frappe.get_all("CRM Lead", filters={"current_department": "Product Listing"}, fields=["name", "lead_owner", "department_status"])
2026-02-24 12:47:19,960 INFO ipython print(f"Product Listing Leads: {leads}")
2026-02-24 12:47:19,960 INFO ipython if leads:
    lead = leads[0]
    # Check ToDo assignments
    todos = frappe.get_all("ToDo", filters={"reference_type": "CRM Lead", "reference_name": lead.name, "status": "Open"}, fields=["allocated_to"])
    print(f"ToDos: {todos}")
    
2026-02-24 12:47:19,960 INFO ipython     # Check DocShare
2026-02-24 12:47:19,960 INFO ipython     shares = frappe.get_all("DocShare", filters={"share_doctype": "CRM Lead", "share_name": lead.name}, fields=["user", "read", "write", "submit", "share"])
2026-02-24 12:47:19,960 INFO ipython     print(f"Shares: {shares}")
2026-02-24 12:47:19,960 INFO ipython === session end ===
2026-02-24 12:55:23,175 INFO ipython === bench console session ===
2026-02-24 12:55:23,175 INFO ipython import frappe
2026-02-24 12:55:23,175 INFO ipython from lead_routing.api.lead_transfer import _assign_to_least_loaded
2026-02-24 12:55:23,175 INFO ipython lead = frappe.get_doc("CRM Lead", "CRM-LEAD-2026-00014")
2026-02-24 12:55:23,176 INFO ipython stage = frappe.get_doc("Department Pipeline Stage", "Product Listing")
2026-02-24 12:55:23,176 INFO ipython print(f"Re-running assignment for Lead {lead.name} to {stage.stage_name}...")
2026-02-24 12:55:23,176 INFO ipython _assign_to_least_loaded(lead, stage)
2026-02-24 12:55:23,176 INFO ipython shares = frappe.get_all("DocShare", filters={"share_doctype": "CRM Lead", "share_name": lead.name}, fields=["user", "read", "write", "submit", "share"])
2026-02-24 12:55:23,176 INFO ipython print(f"Shares after assignment: {shares}")
2026-02-24 12:55:23,176 INFO ipython === session end ===
2026-02-24 16:26:47,359 INFO ipython === bench console session ===
2026-02-24 16:26:47,362 INFO ipython import frappe
2026-02-24 16:26:47,362 INFO ipython def map_fields():
    print("Mapping fields for Ipshopy Seller Hub...")
    try:
        page = frappe.get_doc("Facebook Page", {"page_name": "Ipshopy Seller Hub"})
    except frappe.DoesNotExistError:
        print("Page 'Ipshopy Seller Hub' not found. Ensure forms were fetched.")
        return
        
2026-02-24 16:26:47,362 INFO ipython     forms = frappe.get_all("Facebook Lead Form", filters={"page": page.id})
2026-02-24 16:26:47,362 INFO ipython     print(f"Found {len(forms)} forms.")
2026-02-24 16:26:47,362 INFO ipython     meta = frappe.get_meta("CRM Lead")
2026-02-24 16:26:47,362 INFO ipython     fieldnames = [f.fieldname for f in meta.fields]
2026-02-24 16:26:47,362 INFO ipython     if "custom_field_text" not in fieldnames:
        print("custom_field_text not found in CRM Lead, creating it...")
        custom_field = frappe.get_doc({
            "doctype": "Custom Field",
            "dt": "CRM Lead",
            "fieldname": "custom_field_text",
            "label": "Custom Field Text",
            "fieldtype": "Small Text",
            "insert_after": "mobile_no"
        })
        custom_field.insert(ignore_permissions=True)
        frappe.db.commit()
        print("Created Custom Field.")
2026-02-24 16:26:47,362 INFO ipython     for form_data in forms:
        form = frappe.get_doc("Facebook Lead Form", form_data.name)
        print(f"Form: {form.form_name}")
        for q in form.questions:
            label = q.label.lower()
            key = q.key.lower()
            
2026-02-24 16:26:47,362 INFO ipython             mapped_field = "custom_field_text"
2026-02-24 16:26:47,362 INFO ipython             if "name" in key: mapped_field = "first_name"
2026-02-24 16:26:47,362 INFO ipython             if "email" in key: mapped_field = "email"
2026-02-24 16:26:47,362 INFO ipython             if "phone" in key or "mobile" in key: mapped_field = "mobile_no"
2026-02-24 16:26:47,363 INFO ipython             if "company" in key or "organization" in key: mapped_field = "organization"
2026-02-24 16:26:47,363 INFO ipython             q.mapped_to_crm_field = mapped_field
2026-02-24 16:26:47,363 INFO ipython             print(f"  Mapped {q.label} ({q.key}) -> {mapped_field}")
2026-02-24 16:26:47,363 INFO ipython         form.save(ignore_permissions=True)
2026-02-24 16:26:47,363 INFO ipython         print(f"Saved {form.form_name}")
2026-02-24 16:26:47,363 INFO ipython     frappe.db.commit()
2026-02-24 16:26:47,363 INFO ipython     print("Mapping complete.")
2026-02-24 16:26:47,363 INFO ipython map_fields()
2026-02-24 16:26:47,363 INFO ipython === session end ===
2026-02-24 16:28:59,248 INFO ipython === bench console session ===
2026-02-24 16:28:59,249 INFO ipython import frappe
2026-02-24 16:28:59,249 INFO ipython from crm.api.sync_fb import map_fields
2026-02-24 16:28:59,249 INFO ipython map_fields()
2026-02-24 16:28:59,249 INFO ipython === session end ===
2026-02-24 16:29:32,572 INFO ipython === bench console session ===
2026-02-24 16:29:32,572 INFO ipython import frappe
2026-02-24 16:29:32,572 INFO ipython from crm.api.sync_fb import map_fields
2026-02-24 16:29:32,572 INFO ipython map_fields()
2026-02-24 16:29:32,572 INFO ipython === session end ===
2026-02-24 16:31:53,736 INFO ipython === bench console session ===
2026-02-24 16:31:53,737 INFO ipython import frappe
2026-02-24 16:31:53,738 INFO ipython def create_sources():
    print("Creating Lead Sync Source records...")
    page = frappe.get_doc("Facebook Page", {"page_name": "Ipshopy Seller Hub"})
    forms = frappe.get_all("Facebook Lead Form", filters={"page": page.id})
    token = "EAAcLPVZCYckUBQil7xr6ZAIekyHGZAfk1iuls8b1cFkVkjPwCBmsvq4Tf0wfBT7Typi9ZAJdZAQjgyq36AY4itj97AxqU9B8d5HU4fkZBqe3FWuyisZATIyQU6qhUoaJZBzu4dvcHvfmJwI125QtqpfMuA3AZBJ2YZCfOTIJDn9dLDAyWOITZAfvxXVomowFqImqg9n"
2026-02-24 16:31:53,738 INFO ipython     for form in forms:
        if not frappe.db.exists("Lead Sync Source", {"facebook_lead_form": form.name}):
            doc = frappe.get_doc({
                "doctype": "Lead Sync Source",
                "type": "Facebook",
                "facebook_page": page.id,
                "facebook_lead_form": form.name,
                "access_token": token,
                "enabled": 1,
                "background_sync_frequency": "Every 2 Minutes"
            })
            # avoid calling fetch forms logic inside before_insert
            doc.insert(ignore_permissions=True)
            print(f"Created Sync Source for form: {form.name}")
        else:
            doc = frappe.get_doc("Lead Sync Source", {"facebook_lead_form": form.name})
            doc.background_sync_frequency = "Every 2 Minutes"
            doc.enabled = 1
            doc.access_token = token
            doc.save(ignore_permissions=True)
            print(f"Updated Sync Source for form: {form.name}")
            
2026-02-24 16:31:53,738 INFO ipython     frappe.db.commit()
2026-02-24 16:31:53,739 INFO ipython     print("Done configuring Sync Sources.")
2026-02-24 16:31:53,739 INFO ipython create_sources()
2026-02-24 16:31:53,739 INFO ipython === session end ===
2026-02-24 16:33:17,810 INFO ipython === bench console session ===
2026-02-24 16:33:17,810 INFO ipython from crm.api.create_sources import create_sources
2026-02-24 16:33:17,811 INFO ipython create_sources()
2026-02-24 16:33:17,811 INFO ipython === session end ===
2026-02-24 16:34:25,479 INFO ipython === bench console session ===
2026-02-24 16:34:25,479 INFO ipython from crm.api.create_sources import create_sources
2026-02-24 16:34:25,479 INFO ipython create_sources()
2026-02-24 16:34:25,479 INFO ipython === session end ===
2026-02-24 16:34:50,738 INFO ipython === bench console session ===
2026-02-24 16:34:50,738 INFO ipython from crm.api.create_sources import create_sources
2026-02-24 16:34:50,738 INFO ipython create_sources()
2026-02-24 16:34:50,738 INFO ipython === session end ===
2026-02-24 16:40:16,926 INFO ipython === bench console session ===
2026-02-24 16:40:16,928 INFO ipython import frappe
2026-02-24 16:40:16,928 INFO ipython from crm.api.create_sources import create_sources
2026-02-24 16:40:16,928 INFO ipython frappe.reload_doc('lead_syncing', 'doctype', 'lead_sync_source')
2026-02-24 16:40:16,928 INFO ipython create_sources()
2026-02-24 16:40:16,928 INFO ipython === session end ===
2026-02-25 09:56:42,689 INFO ipython === bench console session ===
2026-02-25 09:56:42,691 INFO ipython import frappe
2026-02-25 09:56:42,691 INFO ipython errors = frappe.get_all("Error Log", fields=["error"], order_by="creation desc", limit=3)
2026-02-25 09:56:42,692 INFO ipython === session end ===
2026-02-25 10:31:52,750 INFO ipython === bench console session ===
2026-02-25 10:31:52,753 INFO ipython import frappe
2026-02-25 10:31:52,753 INFO ipython # Check if there are active forms configured in the system that point to a live ad campaign
2026-02-25 10:31:52,753 INFO ipython sources = frappe.get_all("Lead Sync Source", filters={"type": "Facebook", "enabled": 1}, fields=["facebook_page", "facebook_lead_form"])
2026-02-25 10:31:52,753 INFO ipython === session end ===
2026-02-26 12:43:34,254 INFO ipython === bench console session ===
2026-02-26 12:43:34,291 INFO ipython lead=frappe.get_last_doc('CRM Lead'); print(hasattr(lead, 'get_assigned_users')); print(lead.get_assigned_users() if hasattr(lead, 'get_assigned_users') else 'No')
2026-02-26 12:43:34,291 INFO ipython === session end ===
2026-02-26 12:44:34,146 INFO ipython === bench console session ===
2026-02-26 12:44:34,147 INFO ipython for d in frappe.get_all("Lead Department Log", fields=["name", "parent", "assigned_user", "action"], limit=10): print(d)
2026-02-26 12:44:34,147 INFO ipython === session end ===
2026-02-26 14:01:10,166 INFO ipython === bench console session ===
2026-02-26 14:01:10,168 INFO ipython from lead_routing.api.lead_history import get_my_lead_history
2026-02-26 14:01:10,168 INFO ipython from lead_routing.api.permissions import has_permission
2026-02-26 14:01:10,168 INFO ipython # 1. Test Admin fetching another users history
2026-02-26 14:01:10,168 INFO ipython frappe.set_user("Administrator")
2026-02-26 14:01:10,168 INFO ipython history = get_my_lead_history(user="abc@gmail.com")
2026-02-26 14:01:10,168 INFO ipython print(f"Admin fetched history for: {history.get(\"user\")}")
2026-02-26 14:01:10,168 INFO ipython print(f"Leads found: {len(history.get(\"completed\"))}")
2026-02-26 14:01:10,168 INFO ipython # 2. Test permissions for a lead in that history
2026-02-26 14:01:10,168 INFO ipython if history.get("completed"):
    test_lead_name = history.get("completed")[0].name
    doc = frappe.get_doc("CRM Lead", test_lead_name)
    
2026-02-26 14:01:10,168 INFO ipython     # Check permission for abc@gmail.com
2026-02-26 14:01:10,168 INFO ipython     frappe.set_user("abc@gmail.com")
2026-02-26 14:01:10,168 INFO ipython     can_read = has_permission(doc, ptype="read", user="abc@gmail.com")
2026-02-26 14:01:10,169 INFO ipython     print(f"User abc@gmail.com can read lead {test_lead_name}: {can_read}")
2026-02-26 14:01:10,169 INFO ipython === session end ===
2026-02-26 14:01:34,523 INFO ipython === bench console session ===
2026-02-26 14:01:34,524 INFO ipython from lead_routing.api.lead_history import get_my_lead_history
2026-02-26 14:01:34,524 INFO ipython frappe.set_user("Administrator")
2026-02-26 14:01:34,525 INFO ipython history = get_my_lead_history(user="abc@gmail.com")
2026-02-26 14:01:34,525 INFO ipython print(f"User in Result: {history.get(\"user\")}")
2026-02-26 14:01:34,525 INFO ipython print(f"Currently Assigned: {len(history.get(\"currently_assigned\", []))}")
2026-02-26 14:01:34,526 INFO ipython print(f"Completed: {len(history.get(\"completed\", []))}")
2026-02-26 14:01:34,526 INFO ipython === session end ===
2026-02-26 14:01:42,306 INFO ipython === bench console session ===
2026-02-26 14:01:42,306 INFO ipython from lead_routing.api.lead_history import get_my_lead_history
2026-02-26 14:01:42,306 INFO ipython frappe.set_user("Administrator")
2026-02-26 14:01:42,307 INFO ipython history = get_my_lead_history(user="abc@gmail.com")
2026-02-26 14:01:42,307 INFO ipython print("User in Result: %s" % history.get("user"))
2026-02-26 14:01:42,308 INFO ipython print("Currently Assigned: %d" % len(history.get("currently_assigned", [])))
2026-02-26 14:01:42,308 INFO ipython print("Completed: %d" % len(history.get("completed", [])))
2026-02-26 14:01:42,308 INFO ipython === session end ===
2026-02-26 15:56:00,882 INFO ipython === bench console session ===
2026-02-26 15:56:00,884 INFO ipython import frappe
2026-02-26 15:56:00,884 INFO ipython user = "aakashsusar1234@gmail.com"
2026-02-26 15:56:00,884 INFO ipython night_shift = "Night Shift"
2026-02-26 15:56:00,884 INFO ipython # Add roles for all departments
2026-02-26 15:56:00,884 INFO ipython roles_to_add = [
    "Product Listing User",
    "Google Ads User", 
    "Account Manager User"
]
2026-02-26 15:56:00,884 INFO ipython existing_roles = [r.role for r in frappe.get_all("Has Role", filters={"parent": user}, fields=["role"])]
2026-02-26 15:56:00,884 INFO ipython for role in roles_to_add:
    if role not in existing_roles:
        frappe.get_doc({"doctype": "Has Role", "parent": user, "parenttype": "User", "parentfield": "roles", "role": role}).insert(ignore_permissions=True)
        print(f"Added role: {role}")
    else:
        print(f"Already has role: {role}")
2026-02-26 15:56:00,884 INFO ipython # Add as team member to each department with Night Shift
2026-02-26 15:56:00,884 INFO ipython departments = ["Product Listing", "Google Ads", "Account Manager"]
2026-02-26 15:56:00,884 INFO ipython for dept in departments:
    existing = frappe.get_all("Department Team Member", filters={"parent": dept, "user": user})
    if not existing:
        stage = frappe.get_doc("Department Pipeline Stage", dept)
        stage.append("team_members", {
            "user": user,
            "shift": night_shift,
            "is_active": 1
        })
        stage.save(ignore_permissions=True)
        print(f"Added {user} to {dept} with Night Shift")
    else:
        print(f"Already in {dept}")
2026-02-26 15:56:00,884 INFO ipython frappe.db.commit()
2026-02-26 15:56:00,884 INFO ipython print("\nDone!")
2026-02-26 15:56:00,884 INFO ipython === session end ===
